---
title: "Text-to-CAD Architecture"
description: "Building an intelligent CAD generation system with deep kernel integration"
order: 5
---

This document outlines the architecture for vcad's text-to-CAD system — a model that generates parametric CAD from natural language, with the vcad kernel integrated directly into training.

## Vision

Build the **world's first truly intelligent CAD generation system** that:

- Reasons about mechanical function, not just geometry
- Generates fully parametric, editable designs with design intent preserved
- Understands manufacturing constraints and optimizes for them
- Iteratively refines designs through conversation
- Generates working assemblies with correct kinematics

**The key differentiator**: vcad's kernel isn't just a renderer — it's a reasoning engine integrated into training. The model learns what makes a design *good*, not just what makes it *compile*.

## Current Landscape

| System | Approach | Limitations |
|--------|----------|-------------|
| Text2CAD (NeurIPS '24) | Transformer on DeepCAD sequences | Sketch-extrude only, no solver |
| CAD-Llama (CVPR '25) | LLM fine-tuned with SPCC format | Same DeepCAD limitations |
| Zoo/KittyCAD | Trained ML models → KCL code → B-Rep STEP | Proprietary, architecture undisclosed |
| Text-to-CadQuery | LLM → Python code | Code errors, limited operations |

**Problems with existing approaches:**
1. Limited to sketch-extrude operations (no fillets, patterns, assemblies)
2. No constraint solver in the training loop
3. Mesh-only output — not parametric, not editable
4. No manufacturability awareness

## Architecture

### Core Innovation: Kernel-in-the-Loop Training

```
┌─────────────────────────────────────────────────────────────────┐
│  Text/Image Input                                               │
│       ↓                                                         │
│  [LLM Decoder] ──→ Compact IR Tokens                           │
│       ↓                                                         │
│  [Parser] ──→ vcad IR Document                                 │
│       ↓                                                         │
│  ┌─────────────── KERNEL INTEGRATION ───────────────┐          │
│  │  • Constraint solver feedback (DOF, residual)    │          │
│  │  • Geometry validation (manifold? valid?)        │          │
│  │  • Visual rendering (CLIP similarity)            │          │
│  │  • DFM scoring (printability, machinability)     │          │
│  │  • Physical properties (volume, CoM)             │          │
│  └──────────────────────────────────────────────────┘          │
│       ↓                                                         │
│  Reward signal → DPO/RLHF training                              │
└─────────────────────────────────────────────────────────────────┘
```

### Compact IR Format

Instead of verbose JSON, we use a token-optimized serialization of the vcad IR.

**Current JSON (~150 tokens for simple part):**
```json
{"type":"Cube","size":{"x":50.0,"y":30.0,"z":5.0}}
{"type":"Cylinder","radius":2.0,"height":10.0,"segments":32}
{"type":"Translate","child":1,"offset":{"x":5.0,"y":5.0,"z":-2.5}}
{"type":"Difference","left":0,"right":2}
```

**Compact format (~40 tokens):**
```
C 50 30 5
Y 2 10 32
T 1 5 5 -2.5
D 0 2
```

Single-letter opcodes, positional args, implicit node IDs (line number = ID).

#### Specification

```
# Primitives (line number = node ID)
C sx sy sz                    # Cube
Y r h [segs]                  # Cylinder
S r [segs]                    # Sphere
K rb rt h [segs]              # Cone

# Booleans
U a b                         # Union
D a b                         # Difference
I a b                         # Intersection

# Transforms
T n dx dy dz                  # Translate node n
R n rx ry rz                  # Rotate (degrees)
X n sx sy sz                  # Scale

# Patterns
LP n dx dy dz count spacing   # Linear pattern
CP n ox oy oz ax ay az count angle  # Circular pattern

# Sketch operations
SK ox oy oz xx xy xz yx yy yz # Sketch header
  L x1 y1 x2 y2               # Line segment
  A x1 y1 x2 y2 cx cy [ccw]   # Arc segment
END
E sk dx dy dz                 # Extrude
V sk ox oy oz ax ay az angle  # Revolve

# Modifiers
SH n thickness                # Shell
```

Implementation adds `to_compact()` and `from_compact()` methods to `vcad-ir`.

### Foundation Model

**Recommended: Qwen 2.5-Coder 7B/14B/32B** (Apache 2.0)

| Model | License | Size | Code Strength |
|-------|---------|------|---------------|
| Qwen3-Coder | Apache 2.0 | 0.5B-480B | Best-in-class on benchmarks |
| Qwen 2.5-Coder | Apache 2.0* | 0.5B-32B | Competitive with top models |
| Llama 3.1 | Llama License | 8B-405B | Very good |
| DeepSeek-V3 | MIT (since Mar 2025) | 671B MoE (37B active) | Excellent |

*Apache 2.0 for 0.5B/1.5B/7B/14B/32B; 3B uses Qwen-Research license

**Why Qwen 2.5-Coder:**
1. Purpose-built for code — closer domain to CAD than general LLMs
2. Apache 2.0 — fully permissive, can redistribute fine-tuned weights (most sizes)
3. Size range — 7B for iteration, 32B for production
4. Strong benchmark performance — HumanEval 92.7% (32B), competitive with frontier models
5. CAD-Llama used LLaMA3-8B — we can directly compare and improve

### Training Pipeline

**Stage 1: Adaptive Pretraining**
- Train on compact IR corpus without natural language
- Model learns CAD "grammar" and valid operation sequences

**Stage 2: Instruction Tuning**
- Train on (text description, compact IR) pairs
- Diverse annotations: functional, geometric, manufacturing, casual

**Stage 3: RLHF/DPO with Kernel Rewards**
- Geometric validity reward (valid B-Rep)
- Constraint satisfaction (DOF = 0)
- Visual similarity (CLIP score)
- Manufacturing feasibility (DFM score)

### Reward Functions

```typescript
interface RewardSignals {
  valid: number;        // +1 if manifold, -1 if invalid
  constrained: number;  // f(DOF) → 1.0 when fully constrained
  visual: number;       // CLIP similarity to text description
  dfm: number;          // manufacturability score for process
  dimensions: number;   // accuracy vs specified dimensions
}

function computeReward(ir: Document, prompt: string): number {
  const solid = kernel.evaluate(ir);

  return (
    w1 * (solid.isManifold() ? 1 : -1) +
    w2 * constraintReward(ir.sketches) +
    w3 * clipScore(render(solid), prompt) +
    w4 * dfmScore(solid, extractProcess(prompt))
  );
}
```

### Training Data

| Source | Size | Quality |
|--------|------|---------|
| Synthetic (grammar-based) | 500K+ | High |
| GrabCAD STEP imports | 50K | Medium |
| DeepCAD conversion | 170K | Medium |

**Annotation pipeline**: Generate 10+ diverse text descriptions per design using LLM annotation.

## Capabilities

### Mechanical Reasoning
- "Design a bearing housing" → adds clearances, oil grooves, snap ring grooves
- "This needs to hold 10kg" → reasons about stress, appropriate wall thickness

### Manufacturing-Native
- "for CNC milling" vs "for FDM printing" produces different geometry
- Knows sharp internal corners can't be machined
- Adds draft angles for injection molding

### Engineering Standards
- "M4 mounting holes" → 4.3mm clearance, correct pattern spacing
- "Fits a NEMA 17 stepper" → correct bolt pattern and pilot diameter

### Iterative Refinement
```
User: "Design a motor mount for NEMA 17"
Model: [generates base mount with M3 holes in correct pattern]

User: "Add vibration dampening"
Model: [adds rubber isolation mounts, adjusts hole sizes for grommets]

User: "Check if this is printable"
Model: [runs DFM, reports issues, modifies geometry]
```

### Assembly Intelligence
- Generates multi-part mechanisms with correct kinematics
- Mating faces align, clearances are correct
- Joints have appropriate DOF

## Implementation

### Key Files

| File | Purpose |
|------|---------|
| `crates/vcad-ir/src/compact.rs` | Compact format parser/serializer |
| `crates/vcad-kernel-wasm/src/lib.rs` | WASM bindings for training |
| `packages/engine/src/evaluate.ts` | Evaluation for rewards |
| `crates/vcad-kernel-constraints/src/lib.rs` | Constraint solver |

### Compute Estimate

Reference: CAD-Llama (LLaMA3-8B) required ~50 A100-GPU hours.

| Stage | A100 Hours |
|-------|------------|
| Adaptive pretraining | 50-100 |
| Instruction tuning | 50-100 |
| DPO/RLHF with rewards | 100-200 |
| **Total (7B model)** | **200-400** |

For 32B model, multiply by ~4-5x.

## Competitive Analysis

### Zoo/KittyCAD Limitations (Verified)
- **Cloud-only architecture** — No self-hosting, vendor lock-in, privacy concerns
- **No FEA/simulation** — Can't validate designs before manufacturing
- **No DFM** — Missing manufacturability checks, material selection, cost analysis
- **Basic assembly** — No kinematics, no motion simulation
- **Non-deterministic** — Same prompt can fail/succeed randomly
- **Proprietary ML** — Model weights not open source
- **Struggles with complexity** — Works best for single objects

### The Industry Gap (Nobody Has This)
| Capability | Zoo | Text2CAD | CAD-Llama | **vcad Target** |
|------------|-----|----------|-----------|-----------------|
| Open source model | ❌ | ❌ | ❌ | ✅ |
| Constraint solver in training | ❌ | ❌ | ❌ | ✅ (93% vs 34%) |
| FEA in generation loop | ❌ | ❌ | ❌ | ✅ |
| Manufacturing-aware | ❌ | ❌ | ❌ | ✅ |
| Assembly + kinematics | ❌ | ❌ | ❌ | ✅ (already built) |
| On-premise / offline | ❌ | N/A | N/A | ✅ |
| Multi-turn refinement | ❌ | ❌ | ❌ | ✅ |
| Parametric output | Partial | ❌ | ❌ | ✅ (IR DAG) |

## Differentiation Strategy

### Level 1: Table Stakes (Match Zoo)
- B-Rep STEP output ✅ (vcad has this)
- Basic primitives + booleans ✅ (vcad has this)
- Text-to-CAD generation

### Level 2: Clear Winner (What We Build)
1. **Open source model weights** — Community trust, customization, no vendor lock-in
2. **Constraint solver in training** — 93% fully-constrained vs 34% (Autodesk proved this)
3. **Full parametric output** — Change "50mm" to "60mm", whole design updates
4. **Assembly + kinematics** — vcad ALREADY has joints and forward kinematics
5. **On-premise / offline** — WASM runs locally, no cloud dependency

### Level 3: Legendary (The Moat)
1. **FEA in the generation loop** — "Design a bracket that holds 50kg" → model runs stress analysis during generation, not after
2. **Manufacturing-native** — "for CNC milling" produces different geometry than "for FDM"
3. **Topology optimization** — AI removes material that doesn't contribute to load path
4. **Multi-turn refinement** — "Make it lighter" → coherent modification, not regeneration
5. **Physics-aware trade-offs** — "Minimize weight, max cost increase 20%"

## The Unbeatable Position

**Why vcad wins:**

| Asset | Competitive Value |
|-------|-------------------|
| Custom BRep kernel | Can integrate FEA, topology optimization directly |
| Constraint solver | 93% vs 34% fully-constrained (proven by Autodesk) |
| WASM architecture | Local-first, no cloud lock-in |
| Parametric IR | Designs are editable, auditable, variant-ready |
| Assembly + joints | Already built — competitors don't have this |
| Open source | Community trust, customization, enterprise adoption |

**The moat**: Deep kernel integration that competitors can't replicate without building their own kernel. Zoo uses a cloud geometry engine — they can't put constraint solving in the ML training loop the way we can.

## Legendary Features (The 10x Differentiation)

### 1. Physics-Aware Design Generation

Current systems: *"Generate a bracket"* → output geometry, hope it works

vcad approach:
```
User: "Design a bracket that holds 50kg under 3G shock, minimize weight, SLS-printable"

System:
1. Generate initial geometry
2. Run FEA in kernel (stress analysis)
3. Identify low-stress regions
4. Topology optimization: remove unnecessary material
5. Verify SLS constraints (wall thickness, overhangs)
6. Output manufacturable geometry
```

**Implementation**: Integrate FEA solver into `vcad-kernel`, use topology optimization (SIMP algorithm) in generation loop.

### 2. Multi-Turn Refinement

Not one-shot generation — a design conversation:

```
Turn 1: "Design a motor mount for NEMA 17"
→ [generates mount with M3 holes in correct pattern]

Turn 2: "The bolt holes are too close to the edge"
→ [understands constraint, moves holes, doesn't regenerate from scratch]

Turn 3: "Show me aluminum vs nylon, which is lighter?"
→ [swaps materials in parametric model, compares properties]

Turn 4: "The nylon will warp. Add 1mm wall thickness."
→ [parameter change propagates through IR DAG]
```

**Implementation**: Parametric IR already supports this — LLM just needs to output parameter changes, not full regeneration.

### 3. Manufacturing-Native Generation

Different prompts → different geometry:

| Prompt | Output Differences |
|--------|-------------------|
| "for FDM printing" | No overhangs >45°, chamfers instead of fillets, 1.2mm walls |
| "for CNC milling" | No internal corners < tool radius, add draft angles |
| "for injection molding" | Uniform wall thickness, draft 1-3°, no undercuts |
| "for sheet metal" | Bend radii ≥ thickness, K-factor compensation |

**Implementation**: DFM analyzer in kernel, process-specific reward signals during training.

### 4. Assembly Intelligence (Already Built)

vcad has: joints, forward kinematics, instances, part definitions.

Extend to:
- "Design a 4-bar linkage with 90° output swing" → correct kinematics
- Automatic interference detection
- Assembly sequence planning
- Robot reachability analysis

**Implementation**: Leverage existing `vcad-kernel-constraints` solver, add collision detection.

## The Ultimate Vision: Closed-Loop Physical Manufacturing

### What If We Add a CNC Machine?

```
┌────────────────────────────────────────────────────────────────────────┐
│                    CLOSED-LOOP MANUFACTURING                           │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│  "Make me a bracket that holds 50kg"                                   │
│       ↓                                                                │
│  [Text-to-CAD Model] → vcad IR                                        │
│       ↓                                                                │
│  [FEA Validation] → stress analysis passes                            │
│       ↓                                                                │
│  [CAM Generation] → G-code for THIS machine                           │
│       ↓                                                                │
│  [CNC Machine] → cuts physical part                                   │
│       ↓                                                                │
│  [CMM / 3D Scanner] → measures actual geometry                        │
│       ↓                                                                │
│  [Compare] → expected vs actual                                       │
│       ↓                                                                │
│  [Feedback] → deviations train the model                              │
│       ↓                                                                │
│  Next part is better. Repeat.                                          │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

### Why This Is Game-Changing

**Current state of AI manufacturing:**
- Digital twins simulate but don't learn from physical outcomes
- Text-to-G-code exists (Toolpath raised $20M) but isn't design-aware
- Closed-loop CNC exists but isn't connected to design generation

**What nobody has:**
- Model that learns from **physical manufacturing outcomes**
- Design that's optimized for **THIS specific machine** (not generic)
- RL from real-world feedback (like Tesla FSD learns from real driving)
- Sim-to-real gap **solved by measuring real parts**

### The Feedback Loop

| Signal | Source | What It Teaches |
|--------|--------|-----------------|
| Dimensional accuracy | CMM measurement | Tool deflection compensation |
| Surface finish | Profilometer / visual | Feed rate optimization |
| Cycle time | Machine logs | Toolpath efficiency |
| Tool wear | Sensor / prediction | Cutting parameter limits |
| Part failures | Stress testing | Design inadequacy |

### Machine-Specific Optimization

Different machines have different characteristics:
- Tool deflection profiles
- Thermal expansion behavior
- Backlash compensation needs
- Achievable tolerances

A model trained on YOUR machine produces designs optimized for YOUR machine.

```
User: "Make 100 of these brackets"

System (after 10 parts):
- Learned: This machine deflects 0.02mm on deep cuts
- Learned: Thermal expansion adds 0.01mm after 30 min
- Learned: Tool wear causes 0.005mm drift per part
- Compensation: Adjusted toolpath, achieved ±0.01mm on all 100 parts
```

### Hardware Integration

| Component | Purpose | Options |
|-----------|---------|---------|
| CNC Mill | Physical manufacturing | Haas, Tormach, Pocket NC |
| CMM / Scanner | Measurement feedback | Renishaw, FARO, photogrammetry |
| Tool presetter | Tool geometry input | Zoller, Haimer |
| Sensors | Real-time monitoring | Vibration, current, acoustic |

### The vcad + CNC Stack

```
vcad-ir (design)
    ↓
vcad-kernel (geometry + FEA)
    ↓
vcad-cam (toolpath generation)  ← NEW
    ↓
vcad-machine (G-code execution) ← NEW
    ↓
vcad-measure (CMM/scan input)   ← NEW
    ↓
vcad-learn (RL from feedback)   ← NEW
```

### This Is Defensible

**Why competitors can't copy:**
1. Requires owning the full stack (CAD + CAM + Machine interface)
2. Proprietary data from YOUR machine + YOUR measurement setup
3. Compound learning over time (more parts = better model)
4. Physical infrastructure moat (not just software)

**Business model:**
- Sell the integrated stack (software + recommended hardware)
- Or: "vcad Cloud Factory" — upload design, receive physical part
- Data flywheel: Every part manufactured improves the model

## Notes on Model Selection

**DeepSeek-V3** has excellent performance but full fine-tuning requires 24+ H100 GPUs (640GB+ VRAM). LoRA fine-tuning is practical on smaller hardware.

**Qwen 2.5-Coder** offers the best balance of performance, license permissiveness, and fine-tuning practicality for this project.

## References

- [Text2CAD (NeurIPS 2024)](https://arxiv.org/abs/2409.17106) — Spotlight paper, ~170K models, 660K annotations
- [CAD-Llama (CVPR 2025)](https://arxiv.org/abs/2505.04481) — LLaMA3-8B base, 50 A100-hours training
- [Autodesk Constraint Alignment (ICCV 2025)](https://arxiv.org/abs/2504.13178) — 93% vs 34% fully-constrained with solver feedback
- [Text-to-CadQuery](https://arxiv.org/abs/2505.06507)
- [Zoo Text-to-CAD](https://zoo.dev/research/introducing-text-to-cad) — Trained ML models, B-Rep STEP output
